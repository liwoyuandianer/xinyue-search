# Nginx全局配置
user www-data;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 性能优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    gzip on;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # 服务器配置
    server {
        listen 80;
        server_name _;
        root /var/www/public; # Web根目录指向public
        index index.php index.html;

        # 1. 首页和API的伪静态规则 (ThinkPHP) - 已修复
        location / {
            try_files $uri $uri/ /index.php?s=$uri&$args;
        }

        # 2. 后台管理路径的伪静态规则 - 已修复
        location /qfadmin {
            alias /var/www/qfadmin/;
            try_files $uri $uri/ /qfadmin/index.php?s=$uri&$args;
        }

        # 3. 统一处理所有PHP请求 (关键优化)
        # 这个配置块可以同时正确处理 /var/www/public 和 /var/www/qfadmin 下的PHP文件
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $request_filename; # $request_filename能自动适配root和alias
            fastcgi_read_timeout 300;
        }

        # 4. 禁止访问敏感目录
        location ~* ^/(runtime|application)/ {
            return 403;
        }
    }
}

